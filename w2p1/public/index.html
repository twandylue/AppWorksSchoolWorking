<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>w2p1</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <script text="text/javascript" src="https://js.tappaysdk.com/tpdirect/v5.5.0"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <!-- 暫不需要css -->
        <!-- <link rel='stylesheet' href="./css/style.css"> -->        
    </head>
    <body>
        <header>   
            <h1>w2p1</h1>
        </header>
        <section>
            <!-- <h2>Shopping cart: </h2>
            <label>Please enter product_id:
                <input class="tpfield" type="text" name="product_id" id="product_id">
            </label>
            <br>
            <label>Please enter total_cost:
                <input class="tpfield" type="text" name="total_cost" id="total_cost">
            </label>
            <br> -->
            <h2>TapPay: </h2>
            <div id="cardview-container"></div>
            <button type="submit" onclick="sendDATA()">PAY</button>
            <!-- onclick = "function()" 點擊按鈕後執行function() -->

            <!-- for test -->
            <pre id="result1"></pre> 
            <pre id="result2"></pre>
            <!-- for test -->
            <br>
            <br>

            <div class="to_show">
                <div id="message"></div>
            </div>
        </section>
    
    <!-- js -->
    <script>
        TPDirect.setupSDK(12348, 'app_pa1pQcKoY22IlnSXq5m5WP5jFKzoRG58VEXpT7wU62ud7mMbDOGzCYIlzzLF', 'sandbox');
        TPDirect.card.setup('#cardview-container');
        function sendDATA() {
            // const tappayStatus = TPDirect.card.getTappayFieldsStatus()
            // console.log(tappayStatus)
            // if (tappayStatus.canGetPrime === false) {
            //     alert('can not get prime')
            //     return
            // } // has some problem.
            TPDirect.card.getPrime(function (result) {
                if (result.status !== 0) {
                    alert('get prime error ' + result.msg);
                    return
                }
                alert('get prime 成功，prime: ' + result.card.prime);
                console.log(result.card.prime);

                document.querySelector('#result1').innerHTML = JSON.stringify(result, null, 4) // for test

                // let product_id = document.querySelector('#product_id').value;
                // let total_cost = document.querySelector('#total_cost').value;
                let tappay_prime = result.card.prime;
                let data = {
                    // product_id: product_id,
                    // total_cost: total_cost,
                    tappay_prime: tappay_prime
                }
                console.log(data); // fot test
                let dataString = JSON.stringify(data);
                let tappy = new XMLHttpRequest();
                tappy.onreadystatechange = function () {
                    if (tappy.readyState === 4) {
                        if (tappy.status === 200) {
                            // do something
                        } else {
                            alert(tappy.status);
                        }
                    }
                }
                // tappy.open("POST", 'http://localhost:3000/api/1.0/order/checkout');
                // tappy.open("POST", "http://localhost:3000/order/checkoutPrime");
                tappy.open("POST", 'http://35.73.76.64/api/1.0/order/checkout');
                tappy.setRequestHeader('Content-Type', "application/json");
                tappy.send(dataString);
                
                document.querySelector('#result2').innerHTML = JSON.stringify(dataString, null, 4) // for test

            });
        }
    </script>
    </body>
</html>
